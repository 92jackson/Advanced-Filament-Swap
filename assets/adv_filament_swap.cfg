#######################################################################################
### ADVANCED FILAMENT SWAP by JACKSON92 ###############################################
### Cfg version 2.1.0 #################################################################
#######################################################################################
# Github: https://github.com/92jackson/Advanced-Filament-Swap
# Discord: https://discord.gg/e3eXGTJbjx
#######################################################################################
# Provides a guided filament-change workflow for Klipper 3D printers running Moonraker,
# exposing AFS_STATE and AFS_PUSH hooks so the frontend can render UI and messages.
#######################################################################################
#######################################################################################
#
#######################################################################################
###--- CHANGELOG ---###################################################################
#######################################################################################
# 2025-12-08 - version 2.1.0
# - Added optional T parameter to M600 to pass next filament temperature
# - SWAP_PRINT now honors provided T and heats to it before unload/load
# - Introduced AFS_SET_TARGET macro to override swap/resume temperature via UI
# 2025-11-30 - version 2.0.0
# - Now compatible with both Moonraker web-based frontends (Mainsail and Fluidd)
# - Simplified temperature restoration: uses stored pre-swap temperature
# - Replaced NEWJOB magic numbers (600, 6000, 5999, 5998) with self-documenting string constants
# - Added helper macros: AFS_STORE_TEMPERATURE, AFS_RESTORE_IDLE_TIMEOUT, AFS_INCREMENT_ALERT_COUNT
# - Centralized redundant logic: temperature storage, idle timeout restoration, alert count increment
# - Improved code maintainability by eliminating duplicate code patterns across job handlers
# - Namespaced internals to AFS_* (AFS_CFG, AFS_PUSH, AFS_TEMP_CHECK, AFS_LOAD, AFS_UNLOAD, AFS_NOISE, AFS_SILENT, AFS_IGNORE_M600)
# - Replaced G4 S20 dwells with M400 + G4 P1000 in AFS_LOAD/AFS_UNLOAD
# - Fixed RUN_OUT swapping flag scope; now checks printer["gcode_macro AFS_CFG"].swapping|int
# - Resume heating targets: removed M109 S0; now uses default target fallback
# - Idle timeout: store previous timeout at swap start; restore on resume
# - Beeper guard: M300 silences AFS_NOISE if beeper_pin not configured
# - Pause/resume stability: SAVE_GCODE_STATE/RESTORE_GCODE_STATE added; retract/extrude uses AFS_CFG.retract_park
# - M125 messages and park configuration read from AFS_CFG; messages via AFS_PUSH
# - Added AFS_STATE for WebSocket data retrieval
# - Renamed LOAD_NEW to LOAD_FILAMENT; PURGE_EXTRA removed
# - AFS_LOAD accepts PURGE=<mm> instead of variable_purge
# - Simplified AFS_PUSH: console output only for TYPE=1 origin messages
# - Added delayed cooldown: AFS_COOLDOWN_TIMER + AFS_COOLDOWN_IF_IDLE; added cooldown_delay and split cooldown_m600 vs cooldown_runout
# - Cooldown scheduling on SWAP_PRINT/RUN_OUT; canceled on AFS_LOAD, RESUME, FINISH_SWAP
# - Added cooldown_runout_unprime_mm to extrude then retract that mm before cooling to unprime hotend
# - Added PAUSE BYPASS_RETRACT=1 to skip retract during runout, used for RUN_OUT
# - Improved safe height handling: checks to ensure the desired z isn't above max_z
# - Improved park_x/y position handling: if -1 (or > max), uses toolhead axis_maximum.x/y
# - Added user hooks: AFS_PRE_SWAP (runs before pause) and AFS_POST_SWAP (runs before resume)
# 2023-01-28 - version 1.0.1
# - Small fix
# 2023-01-15 - version 1.0.0
# - Initial release: https://github.com/92jackson/mainsail-advanced-filament-swap
#
 
################################################################################################
# Delete sections [respond], [pause_resume] and [save_variables] if already in your printer.cfg
################################################################################################
[pause_resume]
recover_velocity: 100

[respond]

[save_variables]
filename: ~/variables.cfg


#######################
[gcode_macro AFS_CFG]
#######################
##########################################################
##########################################################
##########################################################
### --- CUSTOMISE YOUR DEFAULT VALUES HERE ---############
##########################################################
##########################################################
##########################################################

variable_defaults:
	{
		"default_temp": 200,			# Default temperature when target invalid or absent
		"cooldown_m600": 1,				# 1=cool hotend on M600; 0=keep hot
		"cooldown_runout": 1,			# 1=cool hotend on RUN_OUT; 0=keep hot
		"cooldown_delay": 120,			# Seconds to wait before cooling if idle (120s=2min)
		"cooldown_runout_unprime_mm": 0,# 0=off; >0 extrude then retract that mm before cooling to unprime hotend
		"auto_unload_manual": 0,		# 1=auto-unload during manual swap; 0=leave unload optional
		"park_x": -1,					# If -1 (or > max), uses toolhead axis_maximum.x
		"park_y": -1,					# If -1 (or > max), uses toolhead axis_maximum.y
		"park_z": 25,					# Relative Z lift at park
		"zmin": 50,						# If current Z < zmin, lift to zmin instead of park_z
		"load_new": 150,				# mm to advance new filament for full color change
		"unload": 300,					# mm to fully unload (bowden length)
		"unload_speed": 1000,			# Speed used for unloading
		"load_speed": 200,				# Speed used for loading/purging
		"park_speed": 10000,			# XY move speed to maintenance position
		"retract_park": 6.5,			# Retract on pause; extrude same on resume
		"timeout": 43200,				# Idle timeout for user input (seconds, 43200=12hr)
		"post_origin_console": 1,		# 1=print origin messages to console; 0=ui-only
		"post_status_console": 0,		# 1=also print status messages to console; 0=ui-only
		"enable_beeper": 1,				# 1=enable beeper on M600+RUN_OUT; 0=disable
		"sound_m600": "FILAMENT_SWAP",	# Sound to play on M600 (Options: FILAMENT_SWAP, RUN_OUT, END, BEEP, ALERT, CHIME)
		"sound_runout": "RUN_OUT",		# Sound to play on RUN_OUT (Options: FILAMENT_SWAP, RUN_OUT, END, BEEP, ALERT, CHIME)
	}

variable_origin_string_data:
	{
		"run_out": "OUT OF FILAMENT! Remove the remaining filament then click [[[FILAMENT_SWAP]]] to start the filament replacement process.",
		"manual_swap_prepare": "Maintenance position ready. You can unload manually by pulling the filament, or click [[[AFS_UNLOAD]]] to use the extruder. Then use [[[LOAD_FILAMENT]]] to advance new filament.",
		"filament_swap_unloading": "FILAMENT SWAP STARTED. Filament unloading, please wait ...",
		"filament_swap_loading": "Load your new filament then click [[[LOAD_FILAMENT]]].",
		"load_new_loaded": "Filament loaded! Use [[[LOAD_FILAMENT]]] to bleed more or [[[FINISH_SWAP]]] to resume printing.",
		"complete": "FILAMENT SWAP COMPLETE! Printer resuming, please wait ..."
	}

variable_status_string_data:
	{
		"homing": "Homing the print head",
		"parking": "Parking the print head",
		"purging": "Purging extra filament...",
		"loading": "Loading filament...",
		"unloading": "Unloading filament...",
		"temp_set": "Setting hotend temperature",
		"heating": "Heating hotend",
		"temp_restored": "Temperature restored",
		"cooling": "Heaters turned off",
		"resuming": "Resuming print...",
		"complete_idle": "Swap complete",
		"waiting": "Waiting for user input...",
		"unpriming": "Unpriming hotend"
	}

##########################################################
##########################################################
##########################################################
### --- YOU SHOULD NOT NEED TO EDIT PAST THIS POINT ---###
##########################################################
##########################################################
##########################################################


variable_temperature: 0
variable_ispaused : 0
variable_swapping : 0
variable_ignore_m600 : 0
variable_prev_idle_timeout : 0
variable_bypass_retract : 0

gcode:
	{% set NEWJOB = params.NEWJOB|default("SWAP_MANUAL")|string %}
	{% set timeout = printer["gcode_macro AFS_CFG"].defaults.timeout|int %}
	{% set cooldown_m600 = printer["gcode_macro AFS_CFG"].defaults.cooldown_m600|int %}
	{% set cooldown_runout = printer["gcode_macro AFS_CFG"].defaults.cooldown_runout|int %}

	{% if curralertcount == null %}
		{% set curralertcount = printer.save_variables.variables.alertcount %}

		{% if curralertcount == null %}
			{% set curralertcount = 0 %}
			SAVE_VARIABLE VARIABLE=alertcount VALUE=0
		{% endif %}

		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=processid VALUE={curralertcount}
	{% endif %}

	{% if NEWJOB == 'RUN_OUT' %}
		#Ignore run-out sensor if already swapping filament
		{% if swapping == 0 %}
			AFS_INCREMENT_ALERT_COUNT

			AFS_PUSH TYPE=1 ORIGIN="run_out"

			{% if 'gcode_macro AFS_PRE_SWAP' in printer %}
				AFS_PRE_SWAP
			{% endif %}

			PAUSE BYPASS_RETRACT=1
			{% if cooldown_runout|int == 1 %}
				UPDATE_DELAYED_GCODE ID=AFS_COOLDOWN_TIMER DURATION={printer["gcode_macro AFS_CFG"].defaults.cooldown_delay|int}
			{% endif %}

			AFS_PUSH TYPE=0 ORIGIN="run_out" STATUS="waiting"
			{% if prev_idle_timeout|int == 0 %}
				{% set _restore_idle = 600 %}
				{% if 'idle_timeout' in printer.configfile.config %}
					{% set _idle = printer.configfile.config.idle_timeout %}
					{% if _idle.timeout is defined %}
						{% set _restore_idle = _idle.timeout|int %}
					{% endif %}
				{% endif %}
				SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=prev_idle_timeout VALUE={_restore_idle}
			{% endif %}
			SET_IDLE_TIMEOUT TIMEOUT={timeout}
		{% endif %}
	{% endif %}

	{% if NEWJOB == 'SWAP_PRINT' %}
		# Automatic flow triggered by slicer M600: unload then load
		AFS_STORE_TEMPERATURE
		AFS_INCREMENT_ALERT_COUNT
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=swapping VALUE=1
		AFS_PUSH TYPE=1 ORIGIN="filament_swap_unloading"

		{% if 'gcode_macro AFS_PRE_SWAP' in printer %}
			AFS_PRE_SWAP
		{% endif %}

		{% if params.T is defined %}
			SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=temperature VALUE={params.T|int}
		{% endif %}
		PAUSE
		{% if params.T is defined %}
			AFS_TEMP_CHECK T={params.T|int}
		{% else %}
			AFS_TEMP_CHECK T={temperature}
		{% endif %}
		AFS_UNLOAD
		AFS_PUSH TYPE=1 ORIGIN="filament_swap_loading"
		{% if cooldown_m600|int == 1 %}
			UPDATE_DELAYED_GCODE ID=AFS_COOLDOWN_TIMER DURATION={printer["gcode_macro AFS_CFG"].defaults.cooldown_delay|int}
		{% endif %}

		{% if prev_idle_timeout|int == 0 %}
			{% set _restore_idle = 600 %}
			{% if 'idle_timeout' in printer.configfile.config %}
				{% set _idle = printer.configfile.config.idle_timeout %}
				{% if _idle.timeout is defined %}
					{% set _restore_idle = _idle.timeout|int %}
				{% endif %}
			{% endif %}
			SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=prev_idle_timeout VALUE={_restore_idle}
		{% endif %}
		SET_IDLE_TIMEOUT TIMEOUT={timeout}
	{% endif %}

	{% if NEWJOB == 'SWAP_MANUAL' %}
		# Manual flow: heat and park, let user choose unload method
		AFS_STORE_TEMPERATURE
		AFS_INCREMENT_ALERT_COUNT
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=swapping VALUE=1

		{% if printer["gcode_macro AFS_CFG"].defaults.auto_unload_manual|int == 1 %}
			AFS_PUSH TYPE=1 ORIGIN="filament_swap_unloading"
		{% else %}
			AFS_PUSH TYPE=1 ORIGIN="manual_swap_prepare"
		{% endif %}

		{% if 'gcode_macro AFS_PRE_SWAP' in printer %}
			AFS_PRE_SWAP
		{% endif %}

		PAUSE
		AFS_TEMP_CHECK T={temperature}
		{% if printer["gcode_macro AFS_CFG"].defaults.auto_unload_manual|int == 1 %}
			AFS_UNLOAD
			AFS_PUSH TYPE=1 ORIGIN="filament_swap_loading"
		{% else %}
			AFS_PUSH TYPE=0 STATUS="waiting"
		{% endif %}

		{% if prev_idle_timeout|int == 0 %}
			{% set _restore_idle = 600 %}
			{% if 'idle_timeout' in printer.configfile.config %}
				{% set _idle = printer.configfile.config.idle_timeout %}
				{% if _idle.timeout is defined %}
					{% set _restore_idle = _idle.timeout|int %}
				{% endif %}
			{% endif %}
			SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=prev_idle_timeout VALUE={_restore_idle}
		{% endif %}
		SET_IDLE_TIMEOUT TIMEOUT={timeout}
	{% endif %}

	{% if NEWJOB == 'LOAD' %}
		{% if params.PURGE is defined %}
			AFS_LOAD PURGE={params.PURGE}
		{% else %}
			AFS_LOAD
		{% endif %}

		AFS_PUSH TYPE=1 ORIGIN="load_new_loaded"
	{% endif %}

	{% if NEWJOB == 'COMPLETE' %}
		AFS_PUSH TYPE=1 ORIGIN="complete"

		# Return to the temperature that was set when swap started
		{% set tgt = temperature|int %}
		M109 S{tgt}
		{% if tgt > 0 %}
			AFS_PUSH TYPE=0 ORIGIN="complete" STATUS="temp_restored"
		{% else %}
			AFS_PUSH TYPE=0 ORIGIN="complete" STATUS="cooling"
		{% endif %}

		# Give user time to see the status
		G4 P2000

		AFS_RESTORE_IDLE_TIMEOUT
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=bypass_retract VALUE=0
		
		{% if 'extruder' in printer.configfile.config and printer.extruder.can_extrude|lower == 'true' %}
			G91
			G1 E{printer["gcode_macro AFS_CFG"].defaults.retract_park} F2100
		{% endif %}

		# Custom User Macro Hook (Post-Swap)
		{% if 'gcode_macro AFS_POST_SWAP' in printer %}
			AFS_POST_SWAP
		{% endif %}

		{% set s = printer.print_stats.state %}
		{% if s in ["printing","paused"] %}
			AFS_PUSH TYPE=-1 ORIGIN="complete" STATUS="resuming"
		{% else %}
			AFS_PUSH TYPE=-1 ORIGIN="complete" STATUS="complete_idle"
		{% endif %}

		RESUME
	{% endif %}


###################################
[gcode_macro AFS_STORE_TEMPERATURE]
###################################

description: Helper macro to store current extruder temperature
gcode:
	{% if 'extruder' in printer.configfile.config %}
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=temperature VALUE={printer.extruder.target}
	{% else %}
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=temperature VALUE=0
	{% endif %}


######################################
[gcode_macro AFS_RESTORE_IDLE_TIMEOUT]
######################################

description: Helper macro to restore idle timeout
gcode:
	{% if printer["gcode_macro AFS_CFG"].prev_idle_timeout|int > 0 %}
		SET_IDLE_TIMEOUT TIMEOUT={printer["gcode_macro AFS_CFG"].prev_idle_timeout}
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=prev_idle_timeout VALUE=0
	{% else %}
		{% set _restore_idle = 600 %}
		{% if 'idle_timeout' in printer.configfile.config %}
			{% set _idle = printer.configfile.config.idle_timeout %}
			{% if _idle.timeout is defined %}
				{% set _restore_idle = _idle.timeout|int %}
			{% endif %}
		{% endif %}
		SET_IDLE_TIMEOUT TIMEOUT={_restore_idle}
	{% endif %}


#######################################
[gcode_macro AFS_INCREMENT_ALERT_COUNT]
#######################################

description: Helper macro to increment alert count and update AFS_STATE processid
gcode:
	{% set curralertcount = printer.save_variables.variables.alertcount %}
	{% if curralertcount == null %}
		{% set curralertcount = 0 %}
		SAVE_VARIABLE VARIABLE=alertcount VALUE=0
	{% endif %}
	
	{% set curralertcount = curralertcount + 1 %}
	SAVE_VARIABLE VARIABLE=alertcount VALUE={curralertcount}
	SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=processid VALUE={curralertcount}


##################
[gcode_macro M600]
##################

description: Slicer-triggered filament change
gcode:
	{% if printer["gcode_macro AFS_CFG"].ignore_m600 == 0 %}
		AFS_NOISE SOUND={printer["gcode_macro AFS_CFG"].defaults.sound_m600}
		{% if params.T is defined %}
			AFS_CFG NEWJOB="SWAP_PRINT" T={params.T}
		{% else %}
			AFS_CFG NEWJOB="SWAP_PRINT"
		{% endif %}
	{% endif %}


#####################
[gcode_macro RUN_OUT]
##########################################################
# Point your run-out pin to this macro in your printer.cfg
##########################################################

description: Trigger a run-out alert
gcode:
	{% if printer["gcode_macro AFS_CFG"].swapping|int == 0 %}
		AFS_NOISE SOUND={printer["gcode_macro AFS_CFG"].defaults.sound_runout}
		AFS_CFG NEWJOB="RUN_OUT"	# Run-out
	{% else %}
		M118	"error: Already running M600!"
	{% endif %}


###########################
[gcode_macro FILAMENT_SWAP]
###########################

description: Triggers a change of filament
gcode:
	AFS_CFG NEWJOB="SWAP_MANUAL"	# Starts manual swap


######################
[gcode_macro LOAD_FILAMENT]
######################

description: Advance 150mm or purge by specified length
gcode:
	{% if params.PURGE is defined %}
		AFS_CFG NEWJOB="LOAD" PURGE={params.PURGE}
	{% else %}
		AFS_CFG NEWJOB="LOAD"
	{% endif %}


#########################
[gcode_macro FINISH_SWAP]
#########################

description: Finish the filament change and resume print
gcode:
	# Cancel any pending cooldown timer when finishing
	UPDATE_DELAYED_GCODE ID=AFS_COOLDOWN_TIMER DURATION=0
	AFS_CFG NEWJOB="COMPLETE"	# Resume print


###########################################
# AFS_STATE interface for WebSocket clients
###########################################
# Fields:
# - processid: correlates messages/events in a single alert round
# - push: per-alert sequential counter for ordering
# - origin: source of event (runout, m600, manual)
# - status: sub-step code (e.g., waiting, unloading, loading, purging,
#	 heating, temp_set, homing, parking, ready, finishing)
# - eta: seconds remaining for current timed operation; 0 if not timed
#######################
[gcode_macro AFS_STATE]
#######################
variable_processid: 0
variable_push: 0
variable_origin: ""
variable_status: ""
variable_eta: 0
variable_macros: ""
variable_ts: 0

gcode:
	{% set origin = params.ORIGIN|default("") %}
	{% set status = params.STATUS|default("") %}
	{% set eta = params.ETA|default(0)|int %}
	{% set processid = params.PROCESSID|default(0)|int %}
	{% set push = params.PUSH|default(0)|int %}
	{% set ts = params.TS|default(printer.toolhead.print_time|float)|float %}
	
	{% if origin != "" %}
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=origin VALUE="'{origin}'"
	{% endif %}
	{% if status != "" %}
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=status VALUE="'{status}'"
	{% else %}
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=status VALUE="''"
	{% endif %}
	{% if eta > 0 %}
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=eta VALUE={eta}
	{% else %}
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=eta VALUE=0
	{% endif %}
	{% if processid > 0 %}
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=processid VALUE={processid}
	{% endif %}
	{% if push > 0 %}
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=push VALUE={push}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=ts VALUE={ts}


######################
[gcode_macro AFS_PUSH]
######################

description: Publish AFS_STATE updates and optional console messages

variable_lastalert : 0
variable_currupdatecount : 0

gcode:
	{% set TYPE = params.TYPE|default(0)|int %}
	{% set ORIGIN = params.ORIGIN|default("") %}
	{% set STATUS = params.STATUS|default("") %}
	{% set ETA = params.ETA|default(0)|int %}
	{% set TS_NOW = printer.toolhead.print_time|float %}
	
	{% set curralertcount = printer["gcode_macro AFS_STATE"].processid %}
	{% if curralertcount == null %}
		{% set curralertcount = 0 %}
	{% endif %}
	{% if curralertcount > lastalert %}
		{% set currupdatecount = 0 %}
		SET_GCODE_VARIABLE MACRO=AFS_PUSH VARIABLE=currupdatecount VALUE={0}
		SET_GCODE_VARIABLE MACRO=AFS_PUSH VARIABLE=lastalert VALUE={curralertcount}
	{% endif %}
	{% set next_push = currupdatecount + 1 %}
	SET_GCODE_VARIABLE MACRO=AFS_PUSH VARIABLE=currupdatecount VALUE={next_push}

	{% if TYPE == -1 %} # -1 = close trigger
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=origin VALUE="''"
		SET_GCODE_VARIABLE MACRO=AFS_STATE VARIABLE=status VALUE="''"
	{% else %}
		# Update AFS_STATE with new parameters
		AFS_STATE ORIGIN="{ORIGIN}" STATUS="{STATUS}" ETA={ETA} PROCESSID={curralertcount} PUSH={next_push} TS={TS_NOW}
	{% endif %}
	
	{% set origin_data = printer["gcode_macro AFS_CFG"].origin_string_data %}
	{% set status_data = printer["gcode_macro AFS_CFG"].status_string_data %}

	{% if TYPE == 1 and printer["gcode_macro AFS_CFG"].defaults.post_origin_console|int == 1 %}
		{% if ORIGIN != "" and ORIGIN in origin_data %}
			{% set UPDATE = origin_data[ORIGIN] %}
			RESPOND TYPE=command MSG="{UPDATE}"
		{% endif %}
	{% endif %}

	{% if TYPE == 0 and printer["gcode_macro AFS_CFG"].defaults.post_status_console|int == 1 %}
		{% if STATUS != "" %}
			{% if STATUS in status_data %}
				{% set UPDATE = status_data[STATUS] %}
				RESPOND TYPE=command MSG="{UPDATE}"
			{% else %}
				RESPOND TYPE=command MSG="{STATUS}"
			{% endif %}
		{% endif %}
	{% endif %}


###################
[gcode_macro PAUSE]
###################

description: Pause the actual running print
rename_existing: PAUSE_BASE

gcode:
	{% if printer["gcode_macro AFS_CFG"].ispaused|int == 0 %}
		{% set bypass = params.BYPASS_RETRACT|default(0)|int %}
		AFS_STORE_TEMPERATURE
		PAUSE_BASE
		SAVE_GCODE_STATE NAME=ADV_PAUSE_state
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=bypass_retract VALUE={bypass}
			
		G91
		{% if 'extruder' in printer.configfile.config and printer.extruder.can_extrude|lower == 'true' %}
			{% if bypass == 0 %}
				G1 E-{printer["gcode_macro AFS_CFG"].defaults.retract_park} F2100
			{% endif %}
		{% endif %}
		
		M125
	{% endif %}

	SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=ispaused VALUE=1


####################
[gcode_macro RESUME]
####################

description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
	UPDATE_DELAYED_GCODE ID=AFS_COOLDOWN_TIMER DURATION=0
	{% if 'VELOCITY' in params|upper %}
		{% set get_params = ('VELOCITY=' + params.VELOCITY)	%}
	{% else %}
		{% set get_params = "" %}
	{% endif %}

	SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=ispaused VALUE=0
	SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=swapping VALUE=0
	RESTORE_GCODE_STATE NAME=ADV_PAUSE_state MOVE=0
	RESUME_BASE {get_params}


##################
[gcode_macro M125]
##################

description: Park toolhead at maintenance position
gcode:
	# If we're not homed yet, home the printer
	{% if printer.toolhead.homed_axes != "xyz" %}
		AFS_PUSH TYPE=0 STATUS="homing"
		G28
	{% endif %}
	
	# Set park positon for x,y,z
	# Defaults set to max posion from printer.cfg
	{% set x_park = printer.toolhead.axis_maximum.x|float - 2.0 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float - 2.0 %}
	{% set cfg_park_x = printer["gcode_macro AFS_CFG"].defaults.park_x|float %}
	{% set cfg_park_y = printer["gcode_macro AFS_CFG"].defaults.park_y|float %}
	
	{% if cfg_park_x > -1 and cfg_park_x <= printer.toolhead.axis_maximum.x|float %}
		{% set x_park = cfg_park_x %}
	{% endif %}
	{% if cfg_park_y > -1 and cfg_park_y <= printer.toolhead.axis_maximum.y|float %}
		{% set y_park = cfg_park_y %}
	{% endif %}

	# Calculate safe lift position
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set headroom = max_z - act_z %}
	{% set desired = printer["gcode_macro AFS_CFG"].defaults.park_z|float %}
	{% if act_z < printer["gcode_macro AFS_CFG"].defaults.zmin %}
		{% set desired = printer["gcode_macro AFS_CFG"].defaults.zmin|float - act_z %}
	{% endif %}
	{% if desired > headroom %}
		{% set z_safe = headroom %}
	{% else %}
		{% set z_safe = desired %}
	{% endif %}

	AFS_PUSH TYPE=0 STATUS="parking"

	G91
	G1 Z{z_safe} F900
	G90
	G1 X{x_park} Y{y_park} F{printer["gcode_macro AFS_CFG"].defaults.park_speed|int}


######################
[gcode_macro AFS_LOAD]
######################

description: Low-level load/purge implementation used by LOAD_FILAMENT
gcode:
	M83
	G92 E0.0
	
	# Cancel any pending cooldown timer when progressing
	UPDATE_DELAYED_GCODE ID=AFS_COOLDOWN_TIMER DURATION=0

	AFS_TEMP_CHECK
	
	{% if params.PURGE is defined %}
		{% set _mm = params.PURGE|int %}
		AFS_PUSH TYPE=0 STATUS="purging" ETA={(_mm / printer["gcode_macro AFS_CFG"].defaults.load_speed|int) * 60}
		G1 E{_mm} F{printer["gcode_macro AFS_CFG"].defaults.load_speed|int}
	{% else %}
		AFS_PUSH TYPE=0 STATUS="loading" ETA={(printer["gcode_macro AFS_CFG"].defaults.load_new|int / printer["gcode_macro AFS_CFG"].defaults.load_speed|int) * 60}
		G1 E{printer["gcode_macro AFS_CFG"].defaults.load_new|int} F{printer["gcode_macro AFS_CFG"].defaults.load_speed|int}
	{% endif %}

	# Retract a little to prevent ooze
	G1 E-{printer["gcode_macro AFS_CFG"].defaults.retract_park} F2100
	G92 E0.0
	M400
	G4 P1000


########################
[gcode_macro AFS_UNLOAD]
########################

description: Low-level unload filament operation
gcode:
	AFS_TEMP_CHECK
	AFS_PUSH TYPE=0 STATUS="unloading" ETA={(printer["gcode_macro AFS_CFG"].defaults.unload|int / printer["gcode_macro AFS_CFG"].defaults.unload_speed|int) * 60}

	G91
	# Quickly push 15mm to prevent the end of the filament being bulbous on unload
	G1 E15 F500
	# Unload
	G1 E-{printer["gcode_macro AFS_CFG"].defaults.unload|int} F{printer["gcode_macro AFS_CFG"].defaults.unload_speed|int}
	G92 E0.0
	G90
	M400
	G4 P1000


############################
[gcode_macro AFS_TEMP_CHECK]
############################

description: Heat and validate hotend target temperature with safety checks
gcode:
	{% if not params.OVERRIDE is defined %}
		{% if params.T is defined %}
			{% set TMP=params.T|int%}
			{% if 'extruder' in printer.configfile.config %}
				{% if printer.configfile.config.extruder.max_temp is defined %}
					{% if params.T|int>printer.configfile.config.extruder.max_temp|int %}
					{% set TMP=printer["gcode_macro AFS_CFG"].defaults.default_temp|int %}
					{% endif %}
				{% endif %}
			{% endif %}
			{% if TMP|int==0 %}
				{% set TMP=printer["gcode_macro AFS_CFG"].defaults.default_temp|int %}
			{% endif %}
		{% else %}
			{% set TMP=printer["gcode_macro AFS_CFG"].defaults.default_temp|int %}
			{% if printer["gcode_macro AFS_CFG"].temperature|int > 0 %}
				{% set TMP=printer["gcode_macro AFS_CFG"].temperature %}
			{% endif %}
		{% endif %}

		{% if 'extruder' in printer.configfile.config %}
			{% if printer.configfile.config.extruder.min_extrude_temp is defined %}
				{% if TMP|int<printer.configfile.config.extruder.min_extrude_temp|int %}
					{% set TMP=printer["gcode_macro AFS_CFG"].defaults.default_temp %}
				{% endif%}
			{% endif %}
		{% endif %}
	{% else %}
		{% if params.T is defined %}
			{% set TMP=params.T|int %}
		{% else %}
		{% set TMP=printer["gcode_macro AFS_CFG"].defaults.default_temp %}
		{% endif %}
	{% endif %}

	 # If extruder is hot enough/within -5 degrees celsius of the set temperature
	{% if 'extruder' in printer.configfile.config and (printer.extruder.temperature|int + 5) >= TMP|int %}
		AFS_PUSH TYPE=0 STATUS="temp_set" TMP={TMP}
		M104 S{TMP}
	{% else %}
		AFS_PUSH TYPE=0 STATUS="heating" TMP={TMP}
		M109 S{TMP}
	{% endif %}


#############################
[gcode_macro AFS_SET_TARGET]
#############################

description: Set override temperature for swap and heat to it
gcode:
	{% if params.T is defined %}
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=temperature VALUE={params.T|int}
		AFS_TEMP_CHECK T={params.T|int}
		AFS_PUSH TYPE=0 STATUS="waiting"
	{% endif %}


##################################
[delayed_gcode AFS_COOLDOWN_TIMER]
##################################

gcode:
	AFS_COOLDOWN_IF_IDLE

##################################
[gcode_macro AFS_COOLDOWN_IF_IDLE]
##################################

description: Turns off heaters after idle delay if swap remains active
gcode:
	{% if printer["gcode_macro AFS_CFG"].swapping|int == 1 %}
		{% set origin = printer["gcode_macro AFS_STATE"].origin %}
		{% if origin == "run_out" and printer["gcode_macro AFS_CFG"].defaults.cooldown_runout|int == 1 %}
			AFS_PUSH TYPE=0 STATUS="cooling"
			{% set _mm = printer["gcode_macro AFS_CFG"].defaults.cooldown_runout_unprime_mm|int %}
			{% if _mm > 0 %}
				AFS_PUSH TYPE=0 STATUS="unpriming"
				M83
				G92 E0.0
				G1 E{_mm} F{printer["gcode_macro AFS_CFG"].defaults.load_speed|int}
				M400
				G1 E-{_mm} F{printer["gcode_macro AFS_CFG"].defaults.unload_speed|int}
				M400
			{% endif %}
			M104 S0
		{% elif origin == "filament_swap_loading" and printer["gcode_macro AFS_CFG"].defaults.cooldown_m600|int == 1 %}
			AFS_PUSH TYPE=0 STATUS="cooling"
			M104 S0
		{% endif %}
	{% endif %}


#############################
[gcode_macro AFS_IGNORE_M600]
#############################

description: Ignore accidental M600 commands during print
gcode:
	{% if params.RESET is defined %}
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=ignore_m600 VALUE=0
		M118 Listening for M600 commands
	{% else %}
		SET_GCODE_VARIABLE MACRO=AFS_CFG VARIABLE=ignore_m600 VALUE=1
		M118 Ignoring M600 commands
	{% endif %}


##################
[gcode_macro M300]
##################

description: Play beeper tone via beeper_pin if configured
gcode:
	{% if 'output_pin beeper_pin' in printer.configfile.config %}
		{% set S = params.S|default(1000)|int %}
		{% set P = params.P|default(100)|int %}
		SET_PIN PIN=beeper_pin VALUE=0.85 CYCLE_TIME={ 1.0/S if S > 0 else 1 }
		G4 P{P}
		SET_PIN PIN=beeper_pin VALUE=0
	{% else %}
		SET_GCODE_VARIABLE MACRO=AFS_NOISE VARIABLE=make_silent VALUE=True
	{% endif %}


########################
[gcode_macro AFS_SILENT]
########################

description: Silences AFS_NOISE, RESET=True re-enables sounds
gcode:
	{% if params.RESET is defined %}
		SET_GCODE_VARIABLE MACRO=AFS_NOISE VARIABLE=make_silent VALUE=False
		M118 Listening for AFS_NOISE commands
	{% else %}
		SET_GCODE_VARIABLE MACRO=AFS_NOISE VARIABLE=make_silent VALUE=True
		M118 Ignoring AFS_NOISE commands
	{% endif %}


#######################
[gcode_macro AFS_NOISE]
#######################

description: Output tunes
variable_make_silent: False

gcode:
	{% set _enable = printer["gcode_macro AFS_CFG"].defaults.enable_beeper|default(1)|int %}
	{% if make_silent != True and _enable == 1 %}
		{% if params.SOUND == 'CAKE' %}
			M300 P251 S784							;)
			M300 P249 S740
			M300 P249 S659
			M300 P252 S659
			M300 P267 S740
			M300 P250 S294
			M300 P249 S370
			M300 P251 S294
			M300 P251 S247
			M300 P249 S294
			M300 P249 S370
			M300 P252 S294
			M300 P267 S220
			M300 P250 S294
			M300 P249 S370
			M300 P251 S440
			M300 P251 S784
			M300 P249 S740
			M300 P249 S659
			M300 P252 S659
			M300 P267 S220
			M300 P250 S740
			M300 P249 S370
			M300 P251 S294
			M300 P251 S587
			M300 P249 S294
			M300 P249 S659
			M300 P252 S440
			M300 P267 S220
			M300 P250 S294
			M300 P249 S370
			M300 P251 S294
			M300 P251 S247
			M300 P249 S294
			M300 P249 S370
			M300 P252 S440
			M300 P267 S659
			M300 P250 S330
			M300 P249 S740
			M300 P251 S784
			M300 P251 S247
			M300 P249 S330
			M300 P249 S659
			M300 P252 S554
			M300 P267 S220
			M300 P250 S587
			M300 P249 S392
			M300 P251 S330
			M300 P251 S659
			M300 P249 S330
			M300 P249 S440
			M300 P252 S440
			M300 P267 S220
			M300 P498 S740
		{% elif params.SOUND == 'RUN_OUT' %}
			{% for i in range(20) %}
				M300 S2500 P200
				M300 S1500 P200
			{% endfor %}
		{% elif params.SOUND == 'FILAMENT_SWAP' %}
			{% for i in range(15) %}
				M300 S900 P300
			{% endfor %}
		{% elif params.SOUND == 'BEEP' %}
			M300 S1000 P100
		{% elif params.SOUND == 'ALERT' %}
			M300 S1000 P100
			M300 S1000 P100
			M300 S1000 P100
		{% elif params.SOUND == 'CHIME' %}
			M300 S1000 P100
			M300 S2000 P100
		{% endif %}
	{% endif %}
